<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>消息队列和事件循环 | 草莓牛奶</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/docs/strawberry.png">
    <meta name="description" content="一个笔记本">
    <meta name="author" content="草莓牛奶">
    <meta name="Keywords" content="vuepress 介绍, vuepress 说明, 草莓牛奶">
    
    <link rel="preload" href="/docs/assets/css/0.styles.6b8e1be2.css" as="style"><link rel="preload" href="/docs/assets/js/app.f83263f5.js" as="script"><link rel="preload" href="/docs/assets/js/2.61df76d7.js" as="script"><link rel="preload" href="/docs/assets/js/7.f6894f62.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.e017752f.js"><link rel="prefetch" href="/docs/assets/js/11.14948b35.js"><link rel="prefetch" href="/docs/assets/js/12.13209217.js"><link rel="prefetch" href="/docs/assets/js/13.f60acfdb.js"><link rel="prefetch" href="/docs/assets/js/14.f4003c8d.js"><link rel="prefetch" href="/docs/assets/js/15.ee20c976.js"><link rel="prefetch" href="/docs/assets/js/16.98308acb.js"><link rel="prefetch" href="/docs/assets/js/17.96c70e4f.js"><link rel="prefetch" href="/docs/assets/js/18.475b9e9c.js"><link rel="prefetch" href="/docs/assets/js/19.1f6e3915.js"><link rel="prefetch" href="/docs/assets/js/20.290f5347.js"><link rel="prefetch" href="/docs/assets/js/21.2df47d15.js"><link rel="prefetch" href="/docs/assets/js/22.d2c6cde0.js"><link rel="prefetch" href="/docs/assets/js/23.d9b20639.js"><link rel="prefetch" href="/docs/assets/js/24.071c5575.js"><link rel="prefetch" href="/docs/assets/js/25.16bd1dc7.js"><link rel="prefetch" href="/docs/assets/js/26.195b28e1.js"><link rel="prefetch" href="/docs/assets/js/27.73d48ab6.js"><link rel="prefetch" href="/docs/assets/js/28.31027141.js"><link rel="prefetch" href="/docs/assets/js/29.46669013.js"><link rel="prefetch" href="/docs/assets/js/3.21d58b5a.js"><link rel="prefetch" href="/docs/assets/js/30.51c5e597.js"><link rel="prefetch" href="/docs/assets/js/31.78baab02.js"><link rel="prefetch" href="/docs/assets/js/32.466e3cd8.js"><link rel="prefetch" href="/docs/assets/js/33.103c24d9.js"><link rel="prefetch" href="/docs/assets/js/34.16e16cec.js"><link rel="prefetch" href="/docs/assets/js/35.297d08e3.js"><link rel="prefetch" href="/docs/assets/js/36.f1a8004d.js"><link rel="prefetch" href="/docs/assets/js/37.27a7f22e.js"><link rel="prefetch" href="/docs/assets/js/38.d419b328.js"><link rel="prefetch" href="/docs/assets/js/39.e072de90.js"><link rel="prefetch" href="/docs/assets/js/4.4153d545.js"><link rel="prefetch" href="/docs/assets/js/40.6c2bce7c.js"><link rel="prefetch" href="/docs/assets/js/41.141a7cb3.js"><link rel="prefetch" href="/docs/assets/js/42.08a055ed.js"><link rel="prefetch" href="/docs/assets/js/43.fbb0ffb6.js"><link rel="prefetch" href="/docs/assets/js/44.c4bd1400.js"><link rel="prefetch" href="/docs/assets/js/45.35f85138.js"><link rel="prefetch" href="/docs/assets/js/46.5c7a69cf.js"><link rel="prefetch" href="/docs/assets/js/47.d3189f26.js"><link rel="prefetch" href="/docs/assets/js/48.85fcc229.js"><link rel="prefetch" href="/docs/assets/js/5.bd8e06c0.js"><link rel="prefetch" href="/docs/assets/js/6.8d5527f5.js"><link rel="prefetch" href="/docs/assets/js/8.98e910b4.js"><link rel="prefetch" href="/docs/assets/js/9.acef81fd.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.6b8e1be2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><img src="milk.png" alt="草莓牛奶" class="logo"> <span class="site-name can-hide">草莓牛奶</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="指南" class="dropdown-title"><span class="title">指南</span> <span class="arrow down"></span></button> <button type="button" aria-label="指南" class="mobile-dropdown-title"><span class="title">指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/guide/" class="nav-link">
  Markdown语法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习" class="dropdown-title"><span class="title">学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="学习" class="mobile-dropdown-title"><span class="title">学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/study/javaScript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/git/base01.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/vue/base01.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/english/base01.html" class="nav-link">
  English
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="路线" class="dropdown-title"><span class="title">路线</span> <span class="arrow down"></span></button> <button type="button" aria-label="路线" class="mobile-dropdown-title"><span class="title">路线</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/route/atguigu/base01.html" class="nav-link">
  尚硅谷
</a></li><li class="dropdown-item"><!----> <a href="/docs/route/coderwhy/base01.html" class="nav-link">
  coderwhy
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><span class="title">进阶</span> <span class="arrow down"></span></button> <button type="button" aria-label="进阶" class="mobile-dropdown-title"><span class="title">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/advance/scss/base01.html" class="nav-link">
  Sass
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="读书笔记" class="mobile-dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/readingNote/theDefinitiveGuideToHTML5/part1.html" class="nav-link">
  HTML5权威指南
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><span class="title">专栏</span> <span class="arrow down"></span></button> <button type="button" aria-label="专栏" class="mobile-dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/special-column/browser/base01.html" class="nav-link">
  浏览器工作原理与实践
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zhaodesen" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/strawberry_milk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="指南" class="dropdown-title"><span class="title">指南</span> <span class="arrow down"></span></button> <button type="button" aria-label="指南" class="mobile-dropdown-title"><span class="title">指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/guide/" class="nav-link">
  Markdown语法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习" class="dropdown-title"><span class="title">学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="学习" class="mobile-dropdown-title"><span class="title">学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/study/javaScript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/git/base01.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/vue/base01.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/english/base01.html" class="nav-link">
  English
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="路线" class="dropdown-title"><span class="title">路线</span> <span class="arrow down"></span></button> <button type="button" aria-label="路线" class="mobile-dropdown-title"><span class="title">路线</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/route/atguigu/base01.html" class="nav-link">
  尚硅谷
</a></li><li class="dropdown-item"><!----> <a href="/docs/route/coderwhy/base01.html" class="nav-link">
  coderwhy
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><span class="title">进阶</span> <span class="arrow down"></span></button> <button type="button" aria-label="进阶" class="mobile-dropdown-title"><span class="title">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/advance/scss/base01.html" class="nav-link">
  Sass
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="读书笔记" class="mobile-dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/readingNote/theDefinitiveGuideToHTML5/part1.html" class="nav-link">
  HTML5权威指南
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><span class="title">专栏</span> <span class="arrow down"></span></button> <button type="button" aria-label="专栏" class="mobile-dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/special-column/browser/base01.html" class="nav-link">
  浏览器工作原理与实践
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zhaodesen" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/strawberry_milk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Browser</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/special-column/browser/base01.html" class="sidebar-link">Chrome架构</a></li><li><a href="/docs/special-column/browser/base02.html" class="sidebar-link">TCP协议</a></li><li><a href="/docs/special-column/browser/base03.html" class="sidebar-link">HTTP请求流程</a></li><li><a href="/docs/special-column/browser/base04.html" class="sidebar-link">导航流程</a></li><li><a href="/docs/special-column/browser/base05.html" class="sidebar-link">渲染流程</a></li><li><a href="/docs/special-column/browser/base06.html" class="sidebar-link">变量提升</a></li><li><a href="/docs/special-column/browser/base07.html" class="sidebar-link">调用栈</a></li><li><a href="/docs/special-column/browser/base08.html" class="sidebar-link">块级作用域</a></li><li><a href="/docs/special-column/browser/base09.html" class="sidebar-link">作用域链和闭包</a></li><li><a href="/docs/special-column/browser/base10.html" class="sidebar-link">this</a></li><li><a href="/docs/special-column/browser/base11.html" class="sidebar-link">栈空间和堆空间</a></li><li><a href="/docs/special-column/browser/base12.html" class="sidebar-link">垃圾回收</a></li><li><a href="/docs/special-column/browser/base13.html" class="sidebar-link">编译器和解释器</a></li><li><a href="/docs/special-column/browser/base14.html" aria-current="page" class="active sidebar-link">消息队列和事件循环</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/special-column/browser/base14.html#单线程处理安排好的任务" class="sidebar-link">单线程处理安排好的任务</a></li><li class="sidebar-sub-header"><a href="/docs/special-column/browser/base14.html#线程运行过程中处理新任务" class="sidebar-link">线程运行过程中处理新任务</a></li><li class="sidebar-sub-header"><a href="/docs/special-column/browser/base14.html#处理其他线程发送过来的任务" class="sidebar-link">处理其他线程发送过来的任务</a></li><li class="sidebar-sub-header"><a href="/docs/special-column/browser/base14.html#处理其他进程发送过来的任务" class="sidebar-link">处理其他进程发送过来的任务</a></li><li class="sidebar-sub-header"><a href="/docs/special-column/browser/base14.html#消息队列中的任务类型" class="sidebar-link">消息队列中的任务类型</a></li><li class="sidebar-sub-header"><a href="/docs/special-column/browser/base14.html#如何安全退出" class="sidebar-link">如何安全退出</a></li><li class="sidebar-sub-header"><a href="/docs/special-column/browser/base14.html#页面使用单线程的缺点" class="sidebar-link">页面使用单线程的缺点</a></li><li class="sidebar-sub-header"><a href="/docs/special-column/browser/base14.html#浏览器页面是如何运行的" class="sidebar-link">浏览器页面是如何运行的</a></li></ul></li><li><a href="/docs/special-column/browser/base15.html" class="sidebar-link">setTimeout</a></li><li><a href="/docs/special-column/browser/base16.html" class="sidebar-link">XMLHttpRequest</a></li><li><a href="/docs/special-column/browser/base17.html" class="sidebar-link">宏任务和微任务</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="单线程处理安排好的任务"><a href="#单线程处理安排好的任务" class="header-anchor">#</a> 单线程处理安排好的任务</h2> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>void MainThread(){
     int num1 = 1+2; // 任务 1
     int num2 = 20/5; // 任务 2
     int num3 = 7*8; // 任务 3
     print(&quot; 最终计算的值为:%d,%d,%d&quot;,num,num2,num3)； // 任务 4
  }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="/docs/assets/img/single-thread.72726678.png" alt="single-thread"></p> <h2 id="线程运行过程中处理新任务"><a href="#线程运行过程中处理新任务" class="header-anchor">#</a> 线程运行过程中处理新任务</h2> <p>但并不是所有的任务都是在执行之前统一安排好的，大部分情况下，新的任务是在线程运行过程中产生的。比如在线程执行过程中，又接收到了一个新的任务要求计算<code>10+2</code>，那上面那种方式就无法处理这种情况了。</p> <p>要想在线程运行过程中，能接收并执行新的任务，就需要采用<strong>事件循环机制</strong></p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>//GetInput
// 等待用户从键盘输入一个数字，并返回该输入的数字
int GetInput(){
    int input_number = 0;
    cout&lt;&lt;&quot; 请输入一个数:&quot;;
    cin&gt;&gt;input_number;
    return input_number;
}

// 主线程 (Main Thread)
void MainThread(){
     for(;;){
          int first_num = GetInput()；
          int second_num = GetInput()；
          result_num = first_num + second_num;
          print(&quot; 最终计算的值为:%d&quot;,result_num)；
      }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>相较于第一版的线程，这一版的线程做了两点改进</p> <ul><li>第一点引入了循环机制，具体实现方式是在线程语句最后添加了一个<code>for</code> 循环语句，线程会一直循环执行。</li> <li>第二点是引入了事件，可以在线程运行过程中，等待用户输入的数字，等待过程中线程处于暂停状态，一旦接收到用户输入的信息，那么线程会被激活，然后执行相加运算，最后输出结果。</li></ul> <p>通过引入事件循环机制，就可以让该线程“活”起来了，我们每次输入两个数字，都会打印出两数字相加的结果</p> <p><img src="/docs/assets/img/event-loop.9e0f5953.png" alt="event-loop"></p> <h2 id="处理其他线程发送过来的任务"><a href="#处理其他线程发送过来的任务" class="header-anchor">#</a> 处理其他线程发送过来的任务</h2> <p>上面我们改进了线程的执行方式，引入了事件循环机制，可以让其在执行过程中接受新的任务。不过在第二版的线程模型中，所有的任务都是来自于线程内部的，如果另外一个线程想让主线程执行一个任务，利用第二版的线程模型是无法做到的。</p> <p>那下面我们就来看看其他线程是如何发送消息给渲染主线程的，具体形式你可以参考下图：
<img src="/docs/assets/img/send-message.2eb6a8ec.png" alt="send-message"></p> <p>从上图可以看出，渲染主线程会频繁接收到来自于 <code>IO</code>线程的一些任务，接收到这些任务之后，渲染进程就需要着手处理，比如接收到资源加载完成的消息后，渲染进程就要着手进行 <code>DOM</code> 解析了；接收到鼠标点击的消息后，渲染主线程就要开始执行相应的<code>JavaScript</code>脚本来处理该点击事件。</p> <p>那么如何设计好一个线程模型，能让其能够接收其他线程发送的消息呢？
一个通用模式是使用<strong>消息队列</strong>。在解释如何实现之前，我们先说说什么是消息队列，可以参考下图：
<img src="/docs/assets/img/message-queue.6d141ec0.png" alt="message-queue"></p> <p><strong>消息队列</strong>是一种数据结构，可以存放要执行的任务。它符合队列<strong>先进先出</strong>的特点，也就是说要添加任务的话，添加到队列的尾部；要取出任务的话，从队列头部去取。
有了队列之后，我们就可以继续改造线程模型了，改造方案如下图所示：
<img src="/docs/assets/img/thread-model.2ac6bc03.png" alt="thread-model"></p> <p>从上图可以看出，我们的改造可以分为下面三个步骤：</p> <ol><li>添加一个消息队列；</li> <li><code>IO</code>线程中产生的新任务添加进消息队列尾部；</li> <li>渲染主线程会循环地从消息队列头部中读取任务，执行任务。</li></ol> <p>有了这些步骤之后，那么接下来我们就可以按步骤使用代码来实现第三版的线程模型。</p> <p>首先，构造一个队列。</p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>class TaskQueue{
  public:
  Task takeTask(); // 取出队列头部的一个任务
  void pushTask(Task task); // 添加一个任务到队列尾部
};
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>改造主线程，让主线程从队列中读取任务：</p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>TaskQueue task_queue；
void ProcessTask();
void MainThread(){
  for(;;){
    Task task = task_queue.takeTask();
    ProcessTask(task);
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在上面的代码中，我们添加了一个消息队列的对象，然后在主线程的<code>for</code> 循环代码块中，从消息队列中读取一个任务，然后执行该任务，主线程就这样一直循环往下执行，因此只要消息队列中有任务，主线程就会去执行。</p> <p>主线程执行的任务全部从消息队列中获取。如果有其他线程想要发送任务让主线程去执行，只需要将任务添加到该消息队列中就可以了，添加任务的代码如下：</p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>Task clickTask;
task_queue.pushTask(clickTask)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>由于是多个线程操作同一个消息队列，所以在添加任务和取出任务时还会加上一个同步锁</p> <h2 id="处理其他进程发送过来的任务"><a href="#处理其他进程发送过来的任务" class="header-anchor">#</a> 处理其他进程发送过来的任务</h2> <p>通过使用消息队列，实现了线程之间的消息通信。在 <code>Chrome</code> 中，跨进程之间的任务也是频繁发生的，那么如何处理其他进程发送过来的任务？
<img src="/docs/assets/img/chrome-send-task.e2582e98.png" alt="chrome-send-task"></p> <p>渲染进程专门有一个 <code>IO</code>线程用来接收其他进程传进来的消息，接收到消息之后，会将这些消息组装成任务发送给渲染主线程，后续的步骤就和前面处理其他线程发送的任务一样了</p> <h2 id="消息队列中的任务类型"><a href="#消息队列中的任务类型" class="header-anchor">#</a> 消息队列中的任务类型</h2> <p>消息队列中的任务包含了很多内部消息类型，如<code>输入事件（鼠标滚动、点击、移动）、微任务、文件读写、WebSocket、JavaScript 定时器</code>等等。还包含了很多与页面相关的事件，如 <code>JavaScript 执行、解析 DOM、样式计算、布局计算、CSS 动画</code>等。</p> <p>以上这些事件都是在主线程中执行的，所以在编写 <code>Web</code> 应用时，你还需要衡量这些事件所占用的时长，并想办法解决单个任务占用主线程过久的问题。</p> <h2 id="如何安全退出"><a href="#如何安全退出" class="header-anchor">#</a> 如何安全退出</h2> <p>当页面主线程执行完成之后，<code>Chrome</code>确定要退出当前页面时，页面主线程会设置一个退出标志的变量，在每次执行完一个任务时，判断是否有设置退出标志。</p> <p>如果设置了，那么就直接中断当前的所有任务，退出线程，你可以参考下面代码：</p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>TaskQueue task_queue；
void ProcessTask();
bool keep_running = true;
void MainThread(){
  for(;;){
    Task task = task_queue.takeTask();
    ProcessTask(task);
    if(!keep_running) // 如果设置了退出标志，那么直接退出线程循环
        break;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="页面使用单线程的缺点"><a href="#页面使用单线程的缺点" class="header-anchor">#</a> 页面使用单线程的缺点</h2> <p>页面线程所有执行的任务都来自于消息队列。消息队列是<strong>先进先出</strong>的属性，也就是说放入队列中的任务，需要等待前面的任务被执行完，才会被执行。鉴于这个属性，就有如下两个问题需要解决。</p> <h3 id="_1-如何处理高优先级的任务"><a href="#_1-如何处理高优先级的任务" class="header-anchor">#</a> 1. 如何处理高优先级的任务</h3> <p>比如一个典型的场景是监控 <code>DOM</code> 节点的变化情况（节点的插入、修改、删除等动态变化），然后根据这些变化来处理相应的业务逻辑。一个通用的设计的是，利用 <code>JavaScript</code>设计一套监听接口，当变化发生时，渲染引擎同步调用这些接口，这是一个典型的观察者模式。</p> <p>不过这个模式有个问题，因为 <code>DOM 变</code>化非常频繁，如果每次发生变化的时候，都直接调用相应的 <code>JavaScript</code>接口，那么这个当前的任务执行时间会被拉长，从而导致执行效率的下降。</p> <p>如果将这些 <code>DOM</code> 变化做成异步的消息事件，添加到消息队列的尾部，那么又会影响到监控的实时性，因为在添加到消息队列的过程中，可能前面就有很多任务在排队了。</p> <p>这也就是说，如果<code>DOM</code> 发生变化，采用同步通知的方式，会影响当前任务的执行效率；如果采用异步方式，又会影响到监控的实时性。</p> <p>那该如何权衡效率和实时性呢？</p> <p>针对这种情况，微任务就应用而生了，下面我们来看看微任务是如何权衡效率和实时性的。</p> <p>通常我们把消息队列中的任务称为<strong>宏任务</strong>，每个宏任务中都包含了一个<strong>微任务队列</strong>，在执行宏任务的过程中，如果 <code>DOM</code>有变化，那么就会将该变化添加到微任务列表中，这样就不会影响到宏任务的继续执行，因此也就解决了执行效率的问题。</p> <p>等宏任务中的主要功能都直接完成之后，这时候，渲染引擎并不着急去执行下一个宏任务，而是执行当前宏任务中的微任务，因为 <code>DOM</code> 变化的事件都保存在这些微任务队列中，这样也就解决了实时性问题。</p> <h3 id="_2-如何解决单个任务执行时长过久的问题"><a href="#_2-如何解决单个任务执行时长过久的问题" class="header-anchor">#</a> 2. 如何解决单个任务执行时长过久的问题</h3> <p>因为所有的任务都是在单线程中执行的，所以每次只能执行一个任务，而其他任务就都处于等待状态。如果其中一个任务执行时间过久，那么下一个任务就要等待很长时间。可以参考下图：
<img src="/docs/assets/img/task-execute-too-long.8de4b43f.png" alt="task-execute-too-long"></p> <p>如果在执行动画过程中，其中有个 <code>JavaScript</code> 任务因执行时间过久，占用了动画单帧的时间，这样会给用户制造了卡顿的感觉，这当然是极不好的用户体验。针对这种情况，<code>JavaScript</code>可以通过回调功能来规避这种问题，也就是让要执行的 <code>JavaScript</code> 任务滞后执行</p> <h2 id="浏览器页面是如何运行的"><a href="#浏览器页面是如何运行的" class="header-anchor">#</a> 浏览器页面是如何运行的</h2> <p><img src="/docs/assets/img/Performance.c0d59d5b.png" alt="Performance">
从图中可以看出，点击展开了 <code>Main</code> 这个项目，其记录了主线程执行过程中的所有任务。图中灰色的就是一个个任务，每个任务下面还有子任务，其中的<code>Parse HTML</code>任务，是把 <code>HTML</code>解析为 <code>DOM</code>的任务。值得注意的是，在执行 <code>Parse HTML</code> 的时候，如果遇到 <code>JavaScript</code> 脚本，那么会暂停当前的<code>HTML</code> 解析而去执行 <code>JavaScript</code> 脚本。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/special-column/browser/base13.html" class="prev">
        编译器和解释器
      </a></span> <span class="next"><a href="/docs/special-column/browser/base15.html">
        setTimeout
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/docs/assets/js/app.f83263f5.js" defer></script><script src="/docs/assets/js/2.61df76d7.js" defer></script><script src="/docs/assets/js/7.f6894f62.js" defer></script>
  </body>
</html>
