<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>setTimeout | 草莓牛奶</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/docs/strawberry.png">
    <meta name="description" content="一个笔记本">
    <meta name="author" content="草莓牛奶">
    <meta name="Keywords" content="vuepress 介绍, vuepress 说明, 草莓牛奶">
    
    <link rel="preload" href="/docs/assets/css/0.styles.6b8e1be2.css" as="style"><link rel="preload" href="/docs/assets/js/app.f83263f5.js" as="script"><link rel="preload" href="/docs/assets/js/2.61df76d7.js" as="script"><link rel="preload" href="/docs/assets/js/25.16bd1dc7.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.e017752f.js"><link rel="prefetch" href="/docs/assets/js/11.14948b35.js"><link rel="prefetch" href="/docs/assets/js/12.13209217.js"><link rel="prefetch" href="/docs/assets/js/13.f60acfdb.js"><link rel="prefetch" href="/docs/assets/js/14.f4003c8d.js"><link rel="prefetch" href="/docs/assets/js/15.ee20c976.js"><link rel="prefetch" href="/docs/assets/js/16.98308acb.js"><link rel="prefetch" href="/docs/assets/js/17.96c70e4f.js"><link rel="prefetch" href="/docs/assets/js/18.475b9e9c.js"><link rel="prefetch" href="/docs/assets/js/19.1f6e3915.js"><link rel="prefetch" href="/docs/assets/js/20.290f5347.js"><link rel="prefetch" href="/docs/assets/js/21.2df47d15.js"><link rel="prefetch" href="/docs/assets/js/22.d2c6cde0.js"><link rel="prefetch" href="/docs/assets/js/23.d9b20639.js"><link rel="prefetch" href="/docs/assets/js/24.071c5575.js"><link rel="prefetch" href="/docs/assets/js/26.195b28e1.js"><link rel="prefetch" href="/docs/assets/js/27.73d48ab6.js"><link rel="prefetch" href="/docs/assets/js/28.31027141.js"><link rel="prefetch" href="/docs/assets/js/29.46669013.js"><link rel="prefetch" href="/docs/assets/js/3.21d58b5a.js"><link rel="prefetch" href="/docs/assets/js/30.51c5e597.js"><link rel="prefetch" href="/docs/assets/js/31.78baab02.js"><link rel="prefetch" href="/docs/assets/js/32.466e3cd8.js"><link rel="prefetch" href="/docs/assets/js/33.103c24d9.js"><link rel="prefetch" href="/docs/assets/js/34.16e16cec.js"><link rel="prefetch" href="/docs/assets/js/35.297d08e3.js"><link rel="prefetch" href="/docs/assets/js/36.f1a8004d.js"><link rel="prefetch" href="/docs/assets/js/37.27a7f22e.js"><link rel="prefetch" href="/docs/assets/js/38.d419b328.js"><link rel="prefetch" href="/docs/assets/js/39.e072de90.js"><link rel="prefetch" href="/docs/assets/js/4.4153d545.js"><link rel="prefetch" href="/docs/assets/js/40.6c2bce7c.js"><link rel="prefetch" href="/docs/assets/js/41.141a7cb3.js"><link rel="prefetch" href="/docs/assets/js/42.08a055ed.js"><link rel="prefetch" href="/docs/assets/js/43.fbb0ffb6.js"><link rel="prefetch" href="/docs/assets/js/44.c4bd1400.js"><link rel="prefetch" href="/docs/assets/js/45.35f85138.js"><link rel="prefetch" href="/docs/assets/js/46.5c7a69cf.js"><link rel="prefetch" href="/docs/assets/js/47.d3189f26.js"><link rel="prefetch" href="/docs/assets/js/48.85fcc229.js"><link rel="prefetch" href="/docs/assets/js/5.bd8e06c0.js"><link rel="prefetch" href="/docs/assets/js/6.8d5527f5.js"><link rel="prefetch" href="/docs/assets/js/7.f6894f62.js"><link rel="prefetch" href="/docs/assets/js/8.98e910b4.js"><link rel="prefetch" href="/docs/assets/js/9.acef81fd.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.6b8e1be2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><img src="milk.png" alt="草莓牛奶" class="logo"> <span class="site-name can-hide">草莓牛奶</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="指南" class="dropdown-title"><span class="title">指南</span> <span class="arrow down"></span></button> <button type="button" aria-label="指南" class="mobile-dropdown-title"><span class="title">指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/guide/" class="nav-link">
  Markdown语法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习" class="dropdown-title"><span class="title">学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="学习" class="mobile-dropdown-title"><span class="title">学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/study/javaScript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/git/base01.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/vue/base01.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/english/base01.html" class="nav-link">
  English
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="路线" class="dropdown-title"><span class="title">路线</span> <span class="arrow down"></span></button> <button type="button" aria-label="路线" class="mobile-dropdown-title"><span class="title">路线</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/route/atguigu/base01.html" class="nav-link">
  尚硅谷
</a></li><li class="dropdown-item"><!----> <a href="/docs/route/coderwhy/base01.html" class="nav-link">
  coderwhy
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><span class="title">进阶</span> <span class="arrow down"></span></button> <button type="button" aria-label="进阶" class="mobile-dropdown-title"><span class="title">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/advance/scss/base01.html" class="nav-link">
  Sass
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="读书笔记" class="mobile-dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/readingNote/theDefinitiveGuideToHTML5/part1.html" class="nav-link">
  HTML5权威指南
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><span class="title">专栏</span> <span class="arrow down"></span></button> <button type="button" aria-label="专栏" class="mobile-dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/special-column/browser/base01.html" class="nav-link">
  浏览器工作原理与实践
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zhaodesen" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/strawberry_milk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="指南" class="dropdown-title"><span class="title">指南</span> <span class="arrow down"></span></button> <button type="button" aria-label="指南" class="mobile-dropdown-title"><span class="title">指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/guide/" class="nav-link">
  Markdown语法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习" class="dropdown-title"><span class="title">学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="学习" class="mobile-dropdown-title"><span class="title">学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/study/javaScript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/git/base01.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/vue/base01.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/docs/study/english/base01.html" class="nav-link">
  English
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="路线" class="dropdown-title"><span class="title">路线</span> <span class="arrow down"></span></button> <button type="button" aria-label="路线" class="mobile-dropdown-title"><span class="title">路线</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/route/atguigu/base01.html" class="nav-link">
  尚硅谷
</a></li><li class="dropdown-item"><!----> <a href="/docs/route/coderwhy/base01.html" class="nav-link">
  coderwhy
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><span class="title">进阶</span> <span class="arrow down"></span></button> <button type="button" aria-label="进阶" class="mobile-dropdown-title"><span class="title">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/advance/scss/base01.html" class="nav-link">
  Sass
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="读书笔记" class="mobile-dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/readingNote/theDefinitiveGuideToHTML5/part1.html" class="nav-link">
  HTML5权威指南
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><span class="title">专栏</span> <span class="arrow down"></span></button> <button type="button" aria-label="专栏" class="mobile-dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/special-column/browser/base01.html" class="nav-link">
  浏览器工作原理与实践
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zhaodesen" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/strawberry_milk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Browser</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/special-column/browser/base01.html" class="sidebar-link">Chrome架构</a></li><li><a href="/docs/special-column/browser/base02.html" class="sidebar-link">TCP协议</a></li><li><a href="/docs/special-column/browser/base03.html" class="sidebar-link">HTTP请求流程</a></li><li><a href="/docs/special-column/browser/base04.html" class="sidebar-link">导航流程</a></li><li><a href="/docs/special-column/browser/base05.html" class="sidebar-link">渲染流程</a></li><li><a href="/docs/special-column/browser/base06.html" class="sidebar-link">变量提升</a></li><li><a href="/docs/special-column/browser/base07.html" class="sidebar-link">调用栈</a></li><li><a href="/docs/special-column/browser/base08.html" class="sidebar-link">块级作用域</a></li><li><a href="/docs/special-column/browser/base09.html" class="sidebar-link">作用域链和闭包</a></li><li><a href="/docs/special-column/browser/base10.html" class="sidebar-link">this</a></li><li><a href="/docs/special-column/browser/base11.html" class="sidebar-link">栈空间和堆空间</a></li><li><a href="/docs/special-column/browser/base12.html" class="sidebar-link">垃圾回收</a></li><li><a href="/docs/special-column/browser/base13.html" class="sidebar-link">编译器和解释器</a></li><li><a href="/docs/special-column/browser/base14.html" class="sidebar-link">消息队列和事件循环</a></li><li><a href="/docs/special-column/browser/base15.html" aria-current="page" class="active sidebar-link">setTimeout</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/special-column/browser/base15.html#浏览器怎么实现-settimeout" class="sidebar-link">浏览器怎么实现 setTimeout</a></li><li class="sidebar-sub-header"><a href="/docs/special-column/browser/base15.html#使用-settimeout-的一些注意事项" class="sidebar-link">使用 setTimeout 的一些注意事项</a></li></ul></li><li><a href="/docs/special-column/browser/base16.html" class="sidebar-link">XMLHttpRequest</a></li><li><a href="/docs/special-column/browser/base17.html" class="sidebar-link">宏任务和微任务</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="浏览器怎么实现-settimeout"><a href="#浏览器怎么实现-settimeout" class="header-anchor">#</a> 浏览器怎么实现 <code>setTimeout</code></h2> <p>渲染进程中所有运行在主线程上的任务都需要先添加到消息队列，然后事件循环系统再按照顺序执行消息队列中的任务。下面我们来看看那些典型的事件：</p> <ul><li>当接收到<code>HTML</code>文档数据，渲染引擎就会将解析 <code>DOM</code>事件添加到消息队列中</li> <li>当用户改变了<code>Web</code> 页面的窗口大小，渲染引擎就会将重新布局的事件添加到消息队列中。</li> <li>当触发了 <code>JavaScript</code>引擎垃圾回收机制，渲染引擎会将垃圾回收任务添加到消息队列中。</li> <li>如果要执行一段异步<code>JavaScript</code> 代码，也是需要将执行任务添加到消息队列中。</li></ul> <p>不过通过定时器设置回调函数有点特别，它们需要在指定的时间间隔内被调用，但消息队列中的任务是按照顺序执行的，所以为了保证回调函数能在指定时间内执行，你不能将定时器的回调函数直接添加到消息队列中。</p> <p>那么该怎么设计才能让定时器设置的回调事件在规定时间内被执行呢？
在 <code>Chrome</code> 中除了正常使用的消息队列之外，还有另外一个消息队列，这个队列中维护了需要延迟执行的任务列表，包括了定时器和<code>Chromium</code>内部一些需要延迟执行的任务。所以当通过 <code>JavaScript</code> 创建一个定时器时，渲染进程会将该定时器的回调任务添加到延迟队列中。</p> <p>源码中延迟执行队列的定义如下所示：</p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>DelayedIncomingQueue delayed_incoming_queue;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当通过 <code>JavaScript</code>调用 <code>setTimeout</code> 设置回调函数的时候，渲染进程将会创建一个回调任务，包含了回调函数 <code>showName</code>、当前发起时间、延迟执行时间，其模拟代码如下所示：</p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>struct DelayTask{
  int64 id；
  CallBackFunction cbf;
  int start_time;
  int delay_time;
};
DelayTask timerTask;
timerTask.cbf = showName;
timerTask.start_time = getCurrentTime(); // 获取当前时间
timerTask.delay_time = 200;// 设置延迟执行时间
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>创建好回调任务之后，再将该任务添加到延迟执行队列中，代码如下所示：</p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>delayed_incoming_queue.push(timerTask)；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>消息循环系统是怎么触发延迟队列的?</p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>void ProcessTimerTask(){
  // 从 delayed_incoming_queue 中取出已经到期的定时器任务
  // 依次执行这些任务
}

TaskQueue task_queue；
void ProcessTask();
bool keep_running = true;
void MainTherad(){
  for(;;){
    // 执行消息队列中的任务
    Task task = task_queue.takeTask();
    ProcessTask(task);

    // 执行延迟队列中的任务
    ProcessDelayTask()

    if(!keep_running) // 如果设置了退出标志，那么直接退出线程循环
        break;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><code>ProcessDelayTask</code>函数是专门用来处理延迟执行任务的。处理完消息队列中的一个任务之后，就开始执行 <code>ProcessDelayTask</code> 函数。<code>ProcessDelayTask</code> 函数会根据发起时间和延迟时间计算出到期的任务，然后依次执行这些到期的任务。等到期的任务执行完成之后，再继续下一个循环过程。通过这样的方式，一个完整的定时器就实现了。</p> <p>设置一个定时器，<code>JavaScript</code> 引擎会返回一个定时器的 <code>ID</code>。那通常情况下，当一个定时器的任务还没有被执行的时候，也是可以取消的，具体方法是调用<code>clearTimeout</code> 函数，并传入需要取消的定时器的<code>ID</code>。如下面代码所示：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其实浏览器内部实现取消定时器的操作也是非常简单的，就是直接从 <code>delayed_incoming_queue</code> 延迟队列中，通过 <code>ID</code>查找到对应的任务，然后再将其从队列中删除掉就可以了。</p> <h2 id="使用-settimeout-的一些注意事项"><a href="#使用-settimeout-的一些注意事项" class="header-anchor">#</a> 使用 <code>setTimeout</code> 的一些注意事项</h2> <h3 id="_1-如果当前任务执行时间过久-会影延迟到期定时器任务的执行"><a href="#_1-如果当前任务执行时间过久-会影延迟到期定时器任务的执行" class="header-anchor">#</a> 1. 如果当前任务执行时间过久，会影延迟到期定时器任务的执行</h3> <p>在使用 <code>setTimeout</code>的时候，有很多因素会导致回调函数执行比设定的预期值要久，其中一个就是当前任务执行时间过久从而导致定时器设置的任务被延后执行</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span>bar<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>通过 <code>setTimeout</code>设置的回调任务被放入了消息队列中并且等待下一次执行，这里并不是立即执行的；要执行消息队列中的下个任务，需要等待当前的任务执行完成，由于当前这段代码要执行 <code>5000</code> 次的<code>for</code> 循环，所以当前这个任务的执行时间会比较久一点。这势必会影响到下个任务的执行时间。
<img src="/docs/assets/img/setTimeout.1adf4da8.png" alt="setTimeout">
执行 <code>foo</code> 函数所消耗的时长是 500 毫秒，这也就意味着通过<code>setTimeout</code>设置的任务会被推迟到 <code>500</code>毫秒以后再去执行，而设置 <code>setTimeout</code>的回调延迟时间是<code>0</code>。</p> <h3 id="_2-如果-settimeout-存在嵌套调用-那么系统会设置最短时间间隔为4-毫秒"><a href="#_2-如果-settimeout-存在嵌套调用-那么系统会设置最短时间间隔为4-毫秒" class="header-anchor">#</a> 2. 如果 <code>setTimeout</code> 存在嵌套调用，那么系统会设置最短时间间隔为<code>4</code> 毫秒</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="data:image/png;base64,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" alt="setTimeout-nest">
上图中的竖线就是定时器的函数回调过程，从图中可以看出，前面五次调用的时间间隔比较小，嵌套调用超过五次以上，后面每次的调用最小时间间隔是<code>4</code>毫秒。之所以出现这样的情况，是因为在 <code>Chrome</code>中，定时器被嵌套调用<code>5</code>次以上，系统会判断该函数方法被阻塞了，如果定时器的调用时间间隔小于 <code>4</code>毫秒，那么浏览器会将每次调用的时间间隔设置为<code>4</code>毫秒。下面是 Chromium 实现 <code>4</code>毫秒延迟的代码，你可以看下：</p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>static const int kMaxTimerNestingLevel = 5;

// Chromium uses a minimum timer interval of 4ms. We'd like to go
// lower; however, there are poorly coded websites out there which do
// create CPU-spinning loops.  Using 4ms prevents the CPU from
// spinning too busily and provides a balance between CPU spinning and
// the smallest possible interval timer.
static constexpr base::TimeDelta kMinimumInterval = base::TimeDelta::FromMilliseconds(4);

base::TimeDelta interval_milliseconds =
      std::max(base::TimeDelta::FromMilliseconds(1), interval);

  if (interval_milliseconds &lt; kMinimumInterval &amp;&amp;
      nesting_level_ &gt;= kMaxTimerNestingLevel)
    interval_milliseconds = kMinimumInterval;

  if (single_shot)
    StartOneShot(interval_milliseconds, FROM_HERE);
  else
    StartRepeating(interval_milliseconds, FROM_HERE);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>所以，一些实时性较高的需求就不太适合使用 <code>setTimeout</code> 了，比如你用<code>setTimeout</code> 来实现<code>JavaScript</code>动画就不是一个很好的主意。</p> <h3 id="_3-未激活的页面-settimeout-执行最小间隔是-1000-毫秒"><a href="#_3-未激活的页面-settimeout-执行最小间隔是-1000-毫秒" class="header-anchor">#</a> 3. 未激活的页面，<code>setTimeout</code> 执行最小间隔是 <code>1000</code> 毫秒</h3> <p>未被激活的页面中定时器最小值大于<code>1000</code>毫秒，也就是说，如果标签不是当前的激活标签，那么定时器最小的时间间隔是 <code>1000</code>毫秒，目的是为了优化后台页面的加载损耗以及降低耗电量。这一点你在使用定时器的时候要注意。</p> <h3 id="_4-延时执行时间有最大值"><a href="#_4-延时执行时间有最大值" class="header-anchor">#</a> 4. 延时执行时间有最大值</h3> <p>除了要了解定时器的回调函数时间比实际设定值要延后之外，还有一点需要注意下，那就是 <code>Chrome、Safari、Firefox</code>都是以<code>32</code>个 <code>bit</code>来存储延时值的，<code>32bit</code> 最大只能存放的数字是<code>2147483647</code>毫秒，这就意味着，如果 <code>setTimeout</code>设置的延迟值大于 <code>2147483647</code>毫秒（大约 <code>24.8</code>天）时就会溢出，这导致定时器会被立即执行。你可以运行下面这段代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">showName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot; 极客时间 &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> timerID <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>showName<span class="token punctuation">,</span> <span class="token number">2147483648</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 会被理解调用执行</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_5-使用settimeout-设置的回调函数中的-this-不符合直觉"><a href="#_5-使用settimeout-设置的回调函数中的-this-不符合直觉" class="header-anchor">#</a> 5. 使用<code>setTimeout</code> 设置的回调函数中的 <code>this</code> 不符合直觉</h3> <p>如果被 <code>setTimeout</code> 推迟执行的回调函数是某个对象的方法，那么该方法中的<code>this</code> 关键字将指向全局环境，而不是定义时所在的那个对象。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> MyObj <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token function-variable function">showName</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>MyObj<span class="token punctuation">.</span>showName<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这里输出的是 <code>1</code>，因为这段代码在编译的时候，执行上下文中的 <code>this</code>会被设置为全局 <code>window</code>，如果是严格模式，会被设置为 <code>undefined</code>。</p> <p>那么该怎么解决这个问题呢？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 箭头函数</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  MyObj<span class="token punctuation">.</span><span class="token function">showName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 或者 function 函数</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MyObj<span class="token punctuation">.</span><span class="token function">showName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 或者</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>MyObj<span class="token punctuation">.</span><span class="token function">showName</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>MyObj<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/special-column/browser/base14.html" class="prev">
        消息队列和事件循环
      </a></span> <span class="next"><a href="/docs/special-column/browser/base16.html">
        XMLHttpRequest
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/docs/assets/js/app.f83263f5.js" defer></script><script src="/docs/assets/js/2.61df76d7.js" defer></script><script src="/docs/assets/js/25.16bd1dc7.js" defer></script>
  </body>
</html>
